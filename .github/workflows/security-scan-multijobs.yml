name: QuÃ©t báº£o máº­t tá»± Ä‘á»™ng vá»›i Trivy vÃ  SonarQube

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

permissions:
  pull-requests: write
  contents: read
  security-events: write

jobs:
  sonarqube:
    name: SonarQube
    runs-on: ubuntu-latest
    environment: SonarScan
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v6

        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ vars.SONAR_HOST_URL }}

  # --- JOB 2: QUÃ‰T THÆ¯ VIá»†N (SCA) Vá»šI TRIVY ---
  trivy-scan:
    name: Trivy Dependency Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy (JSON Output)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          format: 'json'
          output: 'trivy_report.json'
          severity: 'CRITICAL,HIGH'

      - name: Analyze Results & Set Status
        id: analyze
        run: |
          VULN_COUNT=$(jq '[.Results[].Vulnerabilities[]?] | length' trivy_report.json)
          echo "VULN_COUNT=$VULN_COUNT" >> $GITHUB_ENV
          if [ "$VULN_COUNT" -gt 0 ]; then
            echo "SCAN_STATUS=âŒ PHÃT HIá»†N $VULN_COUNT Lá»– Há»”NG (CRITICAL/HIGH)." >> $GITHUB_ENV
          else
            echo "SCAN_STATUS=âœ… Project an toÃ n. KhÃ´ng tÃ¬m tháº¥y lá»— há»•ng nghiÃªm trá»ng." >> $GITHUB_ENV
          fi

      - name: Comment on PR
        if: github.event_name == 'pull_request' && always()
        uses: mshick/add-pr-comment@v2
        with:
          message: |
            ## Káº¿t quáº£ quÃ©t báº£o máº­t Trivy (SCA):
            - **Tráº¡ng thÃ¡i:** ${{ env.SCAN_STATUS }}
            - **Tá»•ng sá»‘ lá»— há»•ng (CRITICAL/HIGH):** `${{ env.VULN_COUNT }}`
            
            ðŸ”— [Nháº¥n vÃ o Ä‘Ã¢y Ä‘á»ƒ xem chi tiáº¿t vÃ  táº£i bÃ¡o cÃ¡o HTML](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            *Ghi chÃº: Náº¿u cÃ³ lá»— há»•ng, vui lÃ²ng kiá»ƒm tra má»¥c **Artifacts** á»Ÿ cuá»‘i trang link bÃªn trÃªn.*

      - name: Generate HTML Report
        if: always()
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          format: 'template'
          template: "@$HOME/.local/bin/trivy-bin/contrib/html.tpl"
          output: 'trivy_report.html'
          severity: 'CRITICAL,HIGH'

      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            trivy_report.html
            trivy_report.json

      - name: Fail Pipeline if Vulns Found
        if: always()
        run: |
          if [ "${{ env.VULN_COUNT }}" -gt 0 ]; then
            exit 1
          fi